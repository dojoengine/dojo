//! > Test expansion of the component contract.

//! > test_runner_name
ExpandContractTestRunner

//! > cairo_code
use dojo::world::ComponentTrait;

#[derive(Component)]
struct Position {
    x: felt252,
    y: felt252
}

trait PositionTrait {
    fn is_zero(self: Position) -> bool;
    fn is_equal(self: Position, b: Position) -> bool;
}

impl PositionImpl of PositionTrait {
    fn is_zero(self: Position) -> bool {
        match self.x - self.y {
            0 => bool::True(()),
            _ => bool::False(()),
        }
    }

    fn is_equal(self: Position, b: Position) -> bool {
        self.x == b.x & self.y == b.y
    }
}

//! > generated_cairo_code
use dojo::world::ComponentTrait;

trait PositionTrait {
    fn is_zero(self: Position) -> bool;
    fn is_equal(self: Position, b: Position) -> bool;
}

impl PositionImpl of PositionTrait {
    fn is_zero(self: Position) -> bool {
        match self.x - self.y {
            0 => bool::True(()),
            _ => bool::False(()),
        }
    }

    fn is_equal(self: Position, b: Position) -> bool {
        self.x == b.x & self.y == b.y
    }
}

use option::OptionTrait;

use starknet::SyscallResult;

use traits::Into;

use traits::TryInto;

#[derive(Copy, Drop)]
struct Position {
    x: felt252,
    y: felt252
}

impl PositionSerde of serde::Serde::<Position> {
    fn serialize(ref serialized: Array::<felt252>, input: Position) {
        serde::Serde::<felt252>::serialize(ref serialized, input.x);
        serde::Serde::<felt252>::serialize(ref serialized, input.y);
    }
    fn deserialize(ref serialized: Span::<felt252>) -> Option::<Position> {
        Option::Some(
            Position {
                x: serde::Serde::<felt252>::deserialize(ref serialized)?,
                y: serde::Serde::<felt252>::deserialize(ref serialized)?,
            }
        )
    }
}

impl StorageAccessPosition of starknet::StorageAccess::<Position> {
    fn read(
        address_domain: felt252, base: starknet::StorageBaseAddress
    ) -> starknet::SyscallResult::<Position> {
        Result::Ok(
            Position {
                x: starknet::storage_read_syscall(
                    address_domain, starknet::storage_address_from_base_and_offset(base, 0_u8)
                )?,
                y: starknet::storage_read_syscall(
                    address_domain, starknet::storage_address_from_base_and_offset(base, 1_u8)
                )?,
            }
        )
    }
    fn write(
        address_domain: felt252, base: starknet::StorageBaseAddress, value: Position
    ) -> starknet::SyscallResult::<()> {
        starknet::storage_write_syscall(
            address_domain, starknet::storage_address_from_base_and_offset(base, 0_u8), value.x
        )?;
        starknet::storage_write_syscall(
            address_domain, starknet::storage_address_from_base_and_offset(base, 1_u8), value.y
        )
    }
}

#[abi]
trait IPosition {
    fn set(entity_id: usize, value: Position);
    fn get(entity_id: usize) -> Position;
}

#[contract]
mod PositionComponent {
    use super::Position;
    use super::PositionSerde;
    use super::StorageAccessPosition;

    struct Storage {
        state: LegacyMap::<usize, Position>, 
    }

    // Initialize Position.
    #[external]
    fn initialize() {}

    // Set the state of an entity.
    #[external]
    fn set(entity_id: usize, value: Position) {
        state::write(entity_id, value);
    }

    // Get the state of an entity.
    #[view]
    fn get(entity_id: usize) -> Position {
        return state::read(entity_id);
    }
}

//! > expected_diagnostics
error: Variable not dropped. Trait has no implementation in context: core::traits::Drop::<core::array::Array::<core::integer::u32>>
 --> serde.cairo:8:9
        serialize_array_u32_helper(ref serialized, ref input);
        ^***************************************************^

error: Variable not dropped. Trait has no implementation in context: core::traits::Drop::<core::array::Array::<core::integer::u32>>
 --> serde.cairo:17:69
fn serialize_array_u32_helper(ref serialized: Array::<felt252>, ref input: Array::<u32>) {
                                                                    ^***^

error: Variable not dropped. Trait has no implementation in context: core::traits::Drop::<core::array::Array::<core::integer::u32>>
 --> serde.cairo:37:42
    ref serialized: Span::<felt252>, mut curr_output: Array::<u32>, remaining: felt252
                                         ^*********^

error: Variable not dropped. Trait has no implementation in context: core::traits::Drop::<core::array::Array::<core::integer::u32>>
 --> serde.cairo:37:42
    ref serialized: Span::<felt252>, mut curr_output: Array::<u32>, remaining: felt252
                                         ^*********^

error: Variable not dropped. Trait has no implementation in context: core::traits::Drop::<core::array::Array::<core::integer::u32>>
 --> contract:52:13
        ref entities: Array::<usize>
            ^******^
