# Dojo Cairo Macros release workflow.
#
name: release-macros

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 1.88.0
  REGISTRY_IMAGE: ghcr.io/${{ github.repository }}

jobs:
  prepare:
    if: (github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'prepare-release-macros') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: release_info
        run: |
          cargo install cargo-get
          echo "tag_name=v$(cargo get workspace.package.version)" >> $GITHUB_OUTPUT

  build-artifacts:
    name: ${{ matrix.job.target }} (${{ matrix.job.os }})
    needs: prepare
    runs-on: ${{ matrix.job.os }}
    env:
      PLATFORM_NAME: ${{ matrix.job.platform }}
      TARGET: ${{ matrix.job.target }}
      ARCH: ${{ matrix.job.arch }}
    strategy:
      matrix:
        job:
          - os: ubuntu-latest-8-cores
            platform: linux
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - os: ubuntu-latest-8-cores-arm64
            platform: linux
            target: aarch64-unknown-linux-gnu
            arch: arm64
            svm_target_platform: linux-aarch64
          - os: macos-latest-xlarge
            platform: darwin
            target: x86_64-apple-darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            target: aarch64-apple-darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        name: Rust Toolchain Setup
        with:
          targets: ${{ matrix.job.target }}
          toolchain: ${{ env.RUST_VERSION }}

      - uses: Swatinem/rust-cache@v1
        with:
          cache-on-failure: true

      - name: Build Dojo Cairo Macros
        run: cargo build --release --locked --manifest-path crates/dojo/macros/Cargo.toml --target ${{ matrix.job.target }}

      - name: Archive binaries
        id: artifacts
        run: |
          # Get the version name from the Cargo.toml file of the
          # dojo cairo macros package.
          VERSION_NAME=$(grep -oP 'version = "\K[^"]+' crates/dojo/macros/Cargo.toml)

          # Determine library extension based on platform
          if [ "$PLATFORM_NAME" == "linux" ]; then
            DLL_EXT="so"
            LIBRARY_NAME="dojo_cairo_macros_v${VERSION_NAME}_${TARGET}.${DLL_EXT}"

            # Rename the library to the desired format
            mv "./target/${TARGET}/release/libdojo_cairo_macros.${DLL_EXT}" "./target/${TARGET}/release/${LIBRARY_NAME}"

            tar -czvf "dojo_${VERSION_NAME}_${PLATFORM_NAME}_${ARCH}.tar.gz" -C ./target/${TARGET}/release sozo "${LIBRARY_NAME}"
            echo "file_name=dojo_${VERSION_NAME}_${PLATFORM_NAME}_${ARCH}.tar.gz" >> $GITHUB_OUTPUT
          elif [ "$PLATFORM_NAME" == "darwin" ]; then
            DLL_EXT="dylib"
            LIBRARY_NAME="dojo_cairo_macros_v${VERSION_NAME}_${TARGET}.${DLL_EXT}"

            # Rename the library to the desired format
            mv "./target/${TARGET}/release/libdojo_cairo_macros.${DLL_EXT}" "./target/${TARGET}/release/${LIBRARY_NAME}"

            # We need to use gtar here otherwise the archive is corrupt.
            # See: https://github.com/actions/virtual-environments/issues/2619
            gtar -czvf "dojo_${PLATFORM_NAME}_${ARCH}.tar.gz" -C ./target/${TARGET}/release sozo "${LIBRARY_NAME}"
            echo "file_name=dojo_${VERSION_NAME}_${PLATFORM_NAME}_${ARCH}.tar.gz" >> $GITHUB_OUTPUT
          else
            # Error with unsupported platform, to prevent one from adding
            # a platform to the matrix without adding the corresponding logic.
            echo "Error: Unsupported platform: $PLATFORM_NAME"
            exit 1
          fi
        shell: bash

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.job.target }}
          path: ${{ steps.artifacts.outputs.file_name }}
          retention-days: 1

  prepare-scarb-plugin:
    runs-on: ubuntu-latest
    needs: [build-artifacts]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          path: artifacts
          merge-multiple: true
      - name: Extract libraries and prepare Scarb plugin structure
        run: |
          # Create the target directory required by Scarb publish command
          # to include pre-built binaries.
          # https://docs.swmansion.com/scarb/docs/reference/procedural-macro.html#prebuilt-procedural-macros
          mkdir -p crates/dojo/macros/target/scarb/cairo-plugin

          # Process each artifact (excluding Windows).
          for artifact in artifacts/artifacts-*; do
            if [[ -f "$artifact" ]]; then
              echo "Processing artifact: $artifact"

              if [[ "$artifact" == *.tar.gz ]]; then
                tar -xzf "$artifact" -C /tmp/

                for lib in /tmp/dojo_cairo_macros_*.{so,dylib}; do
                  if [[ -f "$lib" ]]; then
                    cp "$lib" crates/dojo/macros/target/scarb/cairo-plugin/
                  fi
                done

                rm -f /tmp/dojo_cairo_macros_*.{so,dylib}
              fi
            fi
          done

          # Display the final structure for debug at the moment.
          echo "Final Scarb plugin structure:"
          ls -la creates/dojo/macros
          ls -la crates/dojo/macros/target/scarb/cairo-plugin/

      # - name: Publish to Scarb registry
      #   run: |
      #     cd crates/dojo/macros
      #     SCARB_REGISTRY_AUTH_TOKEN={{secrets.SCARB_REGISTRY_AUTH_TOKEN}} scarb publish --allow-dirty

