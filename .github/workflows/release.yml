# Dojo release workflow.
#
# The main goal of this workflow is to build in release mode the Dojo binaries for all supported platforms.
# Those binaries are then uploaded to be available in `assets` section of the release.
#
# At the end of this workflow, a draft release is created on GitHub, which must be manually published by a maintainer.
# This ensure the release can be reviewed before it is published.
#
# The Dojo docker image is not built during this workflow, to decouple the release of the binaries from the docker image,
# which happens in the `docker.yml` workflow.
#
name: release

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 1.88.0
  REGISTRY_IMAGE: ghcr.io/${{ github.repository }}

jobs:
  prepare:
    if: (github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'prepare-release') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release_info.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: release_info
        run: |
          cargo install cargo-get
          echo "tag_name=v$(cargo get workspace.package.version)" >> $GITHUB_OUTPUT

  publish-scarb-packages:
    
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - uses: actions/checkout@v4

      - uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: "2.13.1"

      - name: Check if Dojo Cairo packages exist on Scarb registry
        id: check_packages
        run: |
          VERSION_NO_V=${{ needs.prepare.outputs.tag_name }}
          VERSION_NO_V=${VERSION_NO_V#v}
          
          echo "Checking if Dojo Cairo packages v${VERSION_NO_V} exist on Scarb registry..."
          
          # Check dojo core
          if curl -f -s "https://scarbs.xyz/api/v1/dl/dojo/${VERSION_NO_V}" > /dev/null; then
            echo "✅ dojo core v${VERSION_NO_V} already exists"
            echo "core_exists=true" >> $GITHUB_OUTPUT
          else
            echo "❌ dojo core v${VERSION_NO_V} not found (404)"
            echo "core_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Check dojo_cairo_test
          if curl -f -s "https://scarbs.xyz/api/v1/dl/dojo_cairo_test/${VERSION_NO_V}" > /dev/null; then
            echo "✅ dojo_cairo_test v${VERSION_NO_V} already exists"
            echo "cairo_test_exists=true" >> $GITHUB_OUTPUT
          else
            echo "❌ dojo_cairo_test v${VERSION_NO_V} not found (404)"
            echo "cairo_test_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Check dojo_snf_test
          if curl -f -s "https://scarbs.xyz/api/v1/dl/dojo_snf_test/${VERSION_NO_V}" > /dev/null; then
            echo "✅ dojo_snf_test v${VERSION_NO_V} already exists"
            echo "snf_test_exists=true" >> $GITHUB_OUTPUT
          else
            echo "❌ dojo_snf_test v${VERSION_NO_V} not found (404)"
            echo "snf_test_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish dojo core
        if: steps.check_packages.outputs.core_exists == 'false'
        run: |
          cd ./crates/dojo/core
          SCARB_REGISTRY_AUTH_TOKEN=${{ secrets.SCARB_REGISTRY_AUTH_TOKEN }} scarb publish

      - name: Publish dojo_cairo_test
        if: steps.check_packages.outputs.cairo_test_exists == 'false'
        run: |
          cd ./crates/dojo/dojo-cairo-test
          SCARB_REGISTRY_AUTH_TOKEN=${{ secrets.SCARB_REGISTRY_AUTH_TOKEN }} scarb publish

      - name: Publish dojo_snf_test
        if: steps.check_packages.outputs.snf_test_exists == 'false'
        run: |
          cd ./crates/dojo/dojo-snf-test
          SCARB_REGISTRY_AUTH_TOKEN=${{ secrets.SCARB_REGISTRY_AUTH_TOKEN }} scarb publish

  create-draft-release:
    runs-on: ubuntu-latest
    needs: [prepare, publish-scarb-packages]
    env:
      GITHUB_USER: ${{ github.repository_owner }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          path: artifacts
          merge-multiple: true
      - id: version_info
        run: |
          cargo install cargo-get
          echo "version=v$(cargo get workspace.package.version)" >> $GITHUB_OUTPUT
      - name: Display structure of downloaded files
        run: ls -R artifacts
      - run: gh release create ${{ steps.version_info.outputs.version }} ./artifacts/*.{gz,zip} --generate-notes --draft
