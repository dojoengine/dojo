#!/usr/bin/env bash
set -euo pipefail

# Function to cleanup background processes
cleanup() {
  local pids=("$@")
  echo "[+] Cleaning up background processes..."
  for pid in "${pids[@]}"; do
    if kill -0 "$pid" 2>/dev/null; then
      kill "$pid" 2>/dev/null || true
    fi
  done
  wait "${pids[@]}" 2>/dev/null || true
}

echo "[+] Starting post-install validation"

# Start by sourcing the .env file of dojo, which should be present
# if the installation was successful.
BASE_DIR=${XDG_CONFIG_HOME:-$HOME}
DOJO_DIR=${DOJO_DIR-"$BASE_DIR/.dojo"}
. "${DOJO_DIR}"/env

KATANA_LOG="/tmp/katana.log"
TORII_LOG="/tmp/torii.log"
TEST_DIR="/tmp/dojo-test"

# 1. Start katana in the background
katana --dev > "${KATANA_LOG}" 2>&1 &
KATANA_PID=$!

# Wait a bit for katana to be up
sleep 2

# Check if katana is running and has no errors
if ! pgrep -f katana > /dev/null || grep -i "error" "${KATANA_LOG}"; then
  echo "[-] Katana failed to start or encountered errors"
  exit 1
fi

echo "[+] Katana started with PID $KATANA_PID"

# 2. Initialize, build and migrate with sozo
rm -rf "${TEST_DIR}"
sozo init "${TEST_DIR}"
cd "${TEST_DIR}"
sozo build
sozo migrate

echo ""

# 3. Start torii with a dummy world address in background.
WORLD_ADDRESS=$(jq -r '.world.address' "${TEST_DIR}/manifest_dev.json")

torii --world "${WORLD_ADDRESS}" > "${TORII_LOG}" 2>&1 &
TORII_PID=$!

# Wait for torii to be up and indexing data.
sleep 2

# Check if torii is running and has no errors
if ! pgrep -f torii > /dev/null || grep -i "error" "${TORII_LOG}"; then
  echo "[-] Torii failed to start or encountered errors"
  cleanup "$KATANA_PID"
  exit 1
fi

echo "[+] Torii started with PID $TORII_PID"

WORLD_CHECK=$(curl -s -X POST http://localhost:8080/sql -d "SELECT contract_address FROM contracts WHERE contract_address = '${WORLD_ADDRESS}';")

WORLD_CHECK=$(echo "${WORLD_CHECK}" | jq -r '.[0].contract_address')

if [ -z "${WORLD_CHECK}" ] || [ "${WORLD_CHECK}" != "${WORLD_ADDRESS}" ]; then
  echo "[-] World address mismatch. Expected: ${WORLD_ADDRESS}, Got: ${WORLD_CHECK}"
  cleanup "$KATANA_PID" "$TORII_PID"
  exit 1
fi

echo "[âœ“] All post-install checks passed"

cleanup "$KATANA_PID" "$TORII_PID"
